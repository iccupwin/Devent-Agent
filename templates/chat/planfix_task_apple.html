{% extends 'base_apple.html' %}
{% load static %}
{% load planfix_filters %}

{% block title %}–ó–∞–¥–∞—á–∏ Planfix{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/apple-modal.css' %}">
{% endblock %}

{% block content %}
<div class="planfix-container">
    <div class="planfix-header">
        <div class="header-content">
            <div class="header-title">
                <h1>–ó–∞–¥–∞—á–∏ Planfix</h1>
                <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Claude</p>
            </div>
        </div>
    </div>
    
    <div class="planfix-main">
        <div class="planfix-search">
            <div class="search-container">
                <input type="text" id="task-search" class="search-input" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á...">
                <button class="search-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </div>
        </div>

        <div class="planfix-controls">
            <div class="planfix-filters">
                <div class="filter-options">
                    <select id="status-filter" class="filter-select">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
                    </select>
                    
                    <select id="project-filter" class="filter-select">
                        <option value="all">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
                        <!-- –ü—Ä–æ–µ–∫—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ API -->
                    </select>

                    <select id="assigner-filter" class="filter-select">
                        <option value="all">–í—Å–µ –ø–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∏</option>
                        <!-- –ü–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ API -->
                    </select>
                </div>
                
                <button id="refresh-button" class="refresh-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 2v6h-6"></path>
                        <path d="M3 12a9 9 0 0 1 15-6.7l3 2.7"></path>
                        <path d="M3 22v-6h6"></path>
                        <path d="M21 12a9 9 0 0 1-15 6.7l-3-2.7"></path>
                    </svg>
                    –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
            
            <div class="table-settings">
                <div class="page-size-selector">
                    <span class="page-size-label">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ:</span>
                    <select id="page-size" class="page-size-select">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                
                <button id="toggle-columns" class="toggle-columns-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="4" y1="6" x2="20" y2="6"></line>
                        <line x1="4" y1="12" x2="20" y2="12"></line>
                        <line x1="4" y1="18" x2="20" y2="18"></line>
                    </svg>
                    –°—Ç–æ–ª–±—Ü—ã
                </button>
            </div>
        </div>
        
        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–æ–ª–±—Ü–æ–≤ -->
        <div id="columns-dropdown" class="columns-dropdown">
            <div class="columns-dropdown-header">–í—ã–±–æ—Ä —Å—Ç–æ–ª–±—Ü–æ–≤</div>
            <div>
                <label class="column-option">
                    <input type="checkbox" checked data-column="id"> ID
                </label>
                <label class="column-option">
                    <input type="checkbox" checked data-column="name"> –ù–∞–∑–≤–∞–Ω–∏–µ
                </label>
                <label class="column-option">
                    <input type="checkbox" checked data-column="status"> –°—Ç–∞—Ç—É—Å
                </label>
                <label class="column-option">
                    <input type="checkbox" checked data-column="project"> –ü—Ä–æ–µ–∫—Ç
                </label>
                <label class="column-option">
                    <input type="checkbox" checked data-column="dates"> –î–∞—Ç—ã
                </label>
                <label class="column-option">
                    <input type="checkbox" checked data-column="assignee"> –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                </label>
                <label class="column-option">
                    <input type="checkbox" checked data-column="actions"> –î–µ–π—Å—Ç–≤–∏—è
                </label>
            </div>
        </div>
        
        <div class="table-container">
            <table class="tasks-table">
                <thead>
                    <tr>
                        <th class="column-id sortable" data-sort="id">
                            ID
                            <span class="sort-icon">‚ñº</span>
                        </th>
                        <th class="column-name sortable" data-sort="name">
                            –ù–∞–∑–≤–∞–Ω–∏–µ
                            <span class="sort-icon">‚ñº</span>
                        </th>
                        <th class="column-status sortable" data-sort="status">
                            –°—Ç–∞—Ç—É—Å
                            <span class="sort-icon">‚ñº</span>
                        </th>
                        <th class="column-project sortable" data-sort="project">
                            –ü—Ä–æ–µ–∫—Ç
                            <span class="sort-icon">‚ñº</span>
                        </th>
                        <th class="column-dates sortable" data-sort="dates">
                            –î–∞—Ç—ã
                            <span class="sort-icon">‚ñº</span>
                        </th>
                        <th class="column-assignee sortable" data-sort="assignee">
                            –ü–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫
                            <span class="sort-icon">‚ñº</span>
                        </th>
                        <th class="column-actions">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="tasks-table-body">
                    {% for task in tasks %}
                    <tr>
                        <td class="column-id">{{ task.id }}</td>
                        <td class="column-name">
                            <a href="#" class="task-name-link" data-task-id="{{ task.id }}">
                                {{ task.name|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}
                                {% if task.description %}
                                <span class="has-description" title="–ï—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ">üìù</span>
                                {% endif %}
                            </a>
                        </td>
                        <td class="column-status">
                            <span class="task-status {{ task.status.name|default:""|lower|cut:" " }}">
                                {{ task.status.name|default:"–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞" }}
                            </span>
                        </td>
                        <td class="column-project">
                            {% if task.project and task.project.name %}
                                <div class="project-badge">
                                    {% with project_id=task.project.id|default:0 %}
                                    {% with color_index=project_id|modulo:8 %}
                                    <div style="background-color: 
                                        {% if color_index == 0 %}#6366f1{% endif %}
                                        {% if color_index == 1 %}#8b5cf6{% endif %}
                                        {% if color_index == 2 %}#ec4899{% endif %}
                                        {% if color_index == 3 %}#f43f5e{% endif %}
                                        {% if color_index == 4 %}#f59e0b{% endif %}
                                        {% if color_index == 5 %}#10b981{% endif %}
                                        {% if color_index == 6 %}#06b6d4{% endif %}
                                        {% if color_index == 7 %}#3b82f6{% endif %}
                                    ">
                                        {{ task.project.name|slice:":1"|upper }}
                                    </div>
                                    {% endwith %}
                                    {% endwith %}
                                    <span class="project-name">{{ task.project.name }}</span>
                                </div>
                            {% else %}
                                <span class="empty-value">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                            {% endif %}
                        </td>
                        <td class="column-dates">
                            <div class="task-dates">
                                {% if task.startDateTime and task.startDateTime.date %}
                                <div class="date-start">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                    {{ task.startDateTime.date }}
                                </div>
                                {% endif %}
                                {% if task.endDateTime and task.endDateTime.date %}
                                <div class="date-end">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                    {{ task.endDateTime.date }}
                                </div>
                                {% endif %}
                                {% if not task.startDateTime or not task.startDateTime.date %}
                                    {% if not task.endDateTime or not task.endDateTime.date %}
                                    <span class="empty-value">–ù–µ —É–∫–∞–∑–∞–Ω—ã</span>
                                {% endif %}
                                {% endif %}
                            </div>
                        </td>
                        <td class="column-assignee">
                            {% if task.assigner and task.assigner.name %}
                                <div class="assignee-wrapper">
                                    <div class="assignee-avatar">
                                        {{ task.assigner.name|slice:":1"|upper }}
                                    </div>
                                    <span class="assignee-name">{{ task.assigner.name }}</span>
                                </div>
                            {% else %}
                                <span class="empty-value">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                            {% endif %}
                        </td>
                        <td class="column-actions">
                            <div class="table-actions">
                                <a href="#" class="btn-icon btn-view" data-task-id="{{ task.id }}" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á–∏">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                </a>
                                <button 
                                    class="btn-icon btn-integrate"
                                    data-task-id="{{ task.id }}"
                                    title="–û–±—Å—É–¥–∏—Ç—å —Å Claude"
                                    {% if task.status.id == 3 %}disabled{% endif %}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="no-tasks-cell">
                            <div class="no-tasks">
                                <div class="no-tasks-icon">üìã</div>
                                <h3>–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á.</p>
                                <button id="reset-filters" class="btn btn-primary">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="pagination-container">
            <div class="pagination-info">
                –ü–æ–∫–∞–∑–∞–Ω–æ <span id="shown-from">{% if tasks %}1{% else %}0{% endif %}</span>-<span id="shown-to">{{ tasks|length }}</span> –∏–∑ <span id="total-count">{{ total_count }}</span> –∑–∞–¥–∞—á
            </div>
            
            <div class="pagination">
                <button id="prev-page" class="pagination-btn" {% if current_page == 1 %}disabled{% endif %}>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    –ù–∞–∑–∞–¥
                </button>
                
                <div class="pagination-pages" id="pagination-pages">
                    <!-- –°—Ç—Ä–∞–Ω–∏—Ü—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    <button class="pagination-page active">1</button>
                </div>
                
                <button id="next-page" class="pagination-btn" {% if current_page >= total_pages %}disabled{% endif %}>
                    –í–ø–µ—Ä—ë–¥
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div id="taskModal" class="apple-modal">
        <div class="apple-modal-content">
            <div class="apple-modal-header">
                <div class="apple-modal-title">
                    <h2 id="modalTaskTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <span id="modalTaskId" class="apple-modal-subtitle">ID: -</span>
                </div>
                <button class="apple-modal-close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="apple-modal-body">
                <div class="apple-task-info">
                    <div class="apple-task-status">
                        <span id="modalTaskStatus" class="apple-status-badge">-</span>
                    </div>
                    <div class="apple-task-details">
                        <div class="apple-task-section">
                            <div class="apple-task-row">
                                <span class="apple-task-label">–ü—Ä–æ–µ–∫—Ç</span>
                                <span id="modalTaskProject" class="apple-task-value">-</span>
                            </div>
                            <div class="apple-task-row">
                                <span class="apple-task-label">–ü–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫</span>
                                <span id="modalTaskAssigner" class="apple-task-value">-</span>
                            </div>
                            <div class="apple-task-row">
                                <span class="apple-task-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</span>
                                <span id="modalTaskAssignee" class="apple-task-value">-</span>
                            </div>
                        </div>
                        <div class="apple-task-section">
                            <div class="apple-task-row">
                                <span class="apple-task-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
                                <span id="modalTaskPriority" class="apple-task-value">-</span>
                            </div>
                            <div class="apple-task-row">
                                <span class="apple-task-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</span>
                                <span id="modalTaskDateStart" class="apple-task-value">-</span>
                            </div>
                            <div class="apple-task-row">
                                <span class="apple-task-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</span>
                                <span id="modalTaskDateEnd" class="apple-task-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="apple-task-description">
                    <h3 class="apple-section-title">–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                    <div id="modalTaskDescription" class="apple-description-content">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∏...</div>
                </div>
                <div class="apple-modal-actions">
                    <button id="modalIntegrateButton" class="apple-button apple-button-primary" data-task-id="">
                        <span class="button-text">–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å Claude</span>
                        <span class="loading-spinner" style="display: none;"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="apple-notification" style="display: none;">
        <div class="apple-notification-content">
            <div id="notification-icon" class="apple-notification-icon"></div>
            <div class="apple-notification-text">
                <div id="notification-title" class="apple-notification-title"></div>
                <div id="notification-message" class="apple-notification-message"></div>
            </div>
            <button id="notification-close" class="apple-notification-close">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Replace the problematic planfix-tasks.js with our new script -->
<script src="{% static 'js/enhanced-table.js' %}"></script>
<script src="{% static 'js/modal-tasks-script.js' %}"></script>
{% endblock %}